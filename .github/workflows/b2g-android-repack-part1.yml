name: b2g-android-repack-part1
on:
  repository_dispatch:
    types: 
      - b2g-repack-android-part1

env:
  SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}} 

jobs:
  Download:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
    - name: Checkout
      uses: actions/checkout@v1
        
    - name: Initialization system environment
      run: |
        df -h
        more /System/Library/CoreServices/SystemVersion.plist
        sudo xcode-select --switch /Applications/Xcode_10.3.app/Contents/Developer
        /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
        brew install expect  gnu-sed ccache
        ln -s /usr/local/bin/gcc-9 /usr/local/bin/gcc
        ln -s /usr/local/bin/g++-9 /usr/local/bin/g++
        #mount
        cd /Users/runner
        hdiutil create -type SPARSE -fs 'Case-sensitive Journaled HFS+' -size 150g ~/android.dmg
        hdiutil attach /Users/runner/android.dmg.sparseimage -mountpoint /Volumes/android
        #zstd
        cd  /Volumes/android
        git clone https://github.com/facebook/zstd.git
        cd zstd
        make
        sudo make install 
        #gupload
        #curl --compressed -s https://raw.githubusercontent.com/labbots/google-drive-upload/master/install.sh | sh -s
        #touch ~/.googledrive.conf
        #echo ${{secrets.GUP_CLIENT_ID}} >> ~/.googledrive.conf
        #echo ${{secrets.GUP_CLIENT_SECRET}} >> ~/.googledrive.conf
        #echo ${{secrets.GUP_ACCESS_TOKEN}} >> ~/.googledrive.conf
        #echo ${{secrets.GUP_ACCESS_TOKEN_EXPIRY}} >> ~/.googledrive.conf
        #echo ${{secrets.GUP_REFRESH_TOKEN}} >> ~/.googledrive.conf
        #echo ${{secrets.GUP_ROOT_FOLDER}} >> ~/.googledrive.conf    
        #ssh
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        #rclone
        mkdir -p ~/.config/rclone
        git clone git@github.com:ittat/tmp.git
        cd tmp
        mv ./rclone.conf ~/.config/rclone
        brew install rclone
        rclone ls itd:test
        
        
        
    - name: Fetch source
      run: |
        df -h
        export CCACHE_DIR=~/.ccache
        /usr/local/bin/ccache  -M 70G
        /usr/local/bin/ccache -s
        #export CCACHE_COMPRESS=1
        export USE_CCACHE=1
        git config --global user.name "ittat"
        git config --global user.email "ittat@github.com"
        cd /Volumes/android
        git clone https://github.com/kaiostech/B2G -b master  --depth=1 
        cd ./B2G
        echo Download ...
        REPO_INIT_FLAGS="--depth=1" REPO_SYNC_FLAGS=" -j128 --force-sync --current-branch --no-tags --no-clone-bundle --optimized-fetch --prune" ./config.sh emulator-10-x86_64
        df -h
        
    - name: fix soucre
      run: |
        df -h
        cd /Volumes/android/B2G
        sed -i '' '14d'  system/sepolicy/tests/Android.bp
        sudo rm -rf .repo
        #sudo rm -r ./gecko
        #sudo rm -r ./gonk-misc
        #git clone https://github.com/OnePlus-onyx/gonk-misc.git -b without-gecko  /Volumes/android/B2G/gonk-misc --depth=1 
        #git clone https://github.com/kaiostech/gonk-binder.git -b master  /Volumes/android/B2G/gonk-misc/gonk-binde --depth=1 
        #ls
        
        # Remove the Gecko build & packaging steps
        patch -d gonk-misc -p1 <<'EOF'
        diff --git a/Android.mk b/Android.mk
        index f0a0eaa..6c8d5eb 100644
        --- a/Android.mk
        +++ b/Android.mk
        @@ -177,15 +177,15 @@ endif
         $(LOCAL_INSTALLED_MODULE) : $(LOCAL_BUILT_MODULE)
                @echo Install dir: $(TARGET_OUT)/b2g
                rm -rf $(filter-out $(addprefix $(TARGET_OUT)/b2g/,$(PRESERVE_DIRS)),$(wildcard $(TARGET_OUT)/b2g/*))
        -       cd $(TARGET_OUT) && tar xvfz $(abspath $<)
        +       :
         ifneq ($(EXPORT_DEVICE_PREFS),)
        -       cp -n $(EXPORT_DEVICE_PREFS)/*.js $(TARGET_OUT)/b2g/defaults/pref/
        +       :
         endif
         ifneq ($(EXPORT_DEVICE_USER_BUILD_PREFS),)
        -       cp -n $(EXPORT_DEVICE_USER_BUILD_PREFS) $(TARGET_OUT)/b2g/defaults/pref/
        +       :
         endif
         ifneq ($(EXPORT_BUILD_PREFS),)
        -       cp -n $(EXPORT_BUILD_PREFS) $(TARGET_OUT)/b2g/defaults/pref/
        +       :
         endif

         GECKO_LIB_DEPS := \
        @@ -250,35 +250,7 @@ endif

         .PHONY: $(LOCAL_BUILT_MODULE)
         $(LOCAL_BUILT_MODULE): $(TARGET_CRTBEGIN_DYNAMIC_O) $(TARGET_CRTEND_O) $(addprefix $(TARGET_OUT_SHARED_LIBRARIES)/,$(GECKO_LIB_DEPS)) $(GECKO_LIB_STATIC)
        -ifeq ($(USE_PREBUILT_B2G),1)
        -       @echo -e "\033[0;33m ==== Use prebuilt gecko ==== \033[0m";
        -       mkdir -p $(@D) && cp $(abspath $(PREFERRED_B2G)) $@
        -else
        -       echo "export GECKO_OBJDIR=$(abspath $(GECKO_OBJDIR))"; \
        -       echo "export GONK_PRODUCT_NAME=$(TARGET_DEVICE)"; \
        -       echo "export GONK_PATH=$(abspath .)"; \
        -       echo "export PLATFORM_VERSION=$(PLATFORM_SDK_VERSION)"; \
        -       echo "export TARGET_ARCH=$(TARGET_ARCH)"; \
        -       echo "export TARGET_ARCH_VARIANT=$(TARGET_ARCH_VARIANT)"; \
        -       echo "export TARGET_CPU_VARIANT=$(TARGET_CPU_VARIANT)"; \
        -       echo "export PRODUCT_MANUFACTURER=$(PRODUCT_MANUFACTURER)"; \
        -       echo "export MOZ_DISABLE_LTO=$(MOZ_DISABLE_LTO)"; \
        -       echo "export HOST_OS=$(HOST_OS)";       \
        -       unset CC_WRAPPER && unset CXX_WRAPPER && \
        -       export GECKO_OBJDIR="$(abspath $(GECKO_OBJDIR))" && \
        -       export GONK_PATH="$(abspath .)" && \
        -       export GONK_PRODUCT_NAME="$(TARGET_DEVICE)" && \
        -       export PLATFORM_VERSION="$(PLATFORM_SDK_VERSION)" && \
        -       export TARGET_ARCH="$(TARGET_ARCH)" && \
        -       export TARGET_ARCH_VARIANT="$(TARGET_ARCH_VARIANT)" && \
        -       export TARGET_CPU_VARIANT="$(TARGET_CPU_VARIANT)" && \
        -       export PRODUCT_MANUFACTURER="$(PRODUCT_MANUFACTURER)" && \
        -       export MOZ_DISABLE_LTO="$(MOZ_DISABLE_LTO)" && \
        -       export HOST_OS="$(HOST_OS)" && \
        -       (cd $(GECKO_PATH) ; $(SHELL) build-b2g.sh) && \
        -       (cd $(GECKO_PATH) ; $(SHELL) build-b2g.sh package) && \
        -       mkdir -p $(@D) && cp $(GECKO_OBJDIR)/dist/b2g-*.tar.gz $@
        -endif
        +       :

         .PHONY: buildsymbols
         buildsymbols:
        EOF

        # Force compressing debug symbols
        patch -d build/soong -p1 <<'EOF'
        diff --git a/cc/config/global.go b/cc/config/global.go
        index 815c31d8..9d82d460 100644
        --- a/cc/config/global.go
        +++ b/cc/config/global.go
        @@ -44,6 +44,7 @@ var (

            "-O2",
            "-g",
        +		"-gz", // Compress debug symbols

            "-fno-strict-aliasing",
          }
        @@ -69,6 +70,7 @@ var (
            "-Werror=sequence-point",
            "-Werror=date-time",
            "-Werror=format-security",
        +		"-gz", // Compress debug symbols
          }

          deviceGlobalCppflags = []string{
        @@ -85,6 +87,7 @@ var (
            "-Wl,--no-undefined-version",
            "-Wl,--exclude-libs,libgcc.a",
            "-Wl,--exclude-libs,libgcc_stripped.a",
        +		"-Wl,--compress-debug-sections=zlib", // Compress debug symbols
          }

          deviceGlobalLldflags = append(ClangFilterUnknownLldflags(deviceGlobalLdflags),
        EOF



    - name: repack soucre
      run: |
        cd  /Volumes/android
        tar -cvf ./B2G.tar ./B2G
        zstd ./B2G.tar
        sudo rm ./B2G.tar
        sudo rm -r ./B2G
        ls -al -h ./
        df -h
        
    - name: update 
      run: |
        df -h
        cd /Volumes/android/
        #mv ./B2G.tar.zst ./B2G.tar.zst
        #~/.google-drive-upload/bin/gupload -o ./B2G.tar.zst
        rclone copy ./B2G.tar.zst itd:ci 
        df -h
        
    - name: send webhook          
      run: |
        cd /Volumes/android/
        curl -H "Authorization: token ${{secrets.GIT_ACCESS_TOKEN}}"   --request POST   --data '{"event_type": "b2g-build1-part2"}'   https://api.github.com/repos/OnePlus-onyx/build-CI/dispatches
        
        
        
