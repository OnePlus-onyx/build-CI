
name: Build System Image

on: 
  push:
    branches:
      - master

jobs:
  build:

    runs-on: macos-latest
    timeout-minutes: 360
    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Initialization system environment
      run: |
        df -h
        /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
        brew install autoconf expect
        ln -s /usr/local/bin/gcc-9 /usr/local/bin/gcc
        ln -s /usr/local/bin/g++-9 /usr/local/bin/g++
        cd /Users/runner
        hdiutil create -type SPARSE -fs 'Case-sensitive Journaled HFS+' -size 200g ~/android.dmg
        hdiutil attach /Users/runner/android.dmg.sparseimage -mountpoint /Volumes/android
        df -h
        
    - name: Fetch source
      run: |
        df -h
        git config --global user.name "ittat"
        git config --global user.email "ittat@github.com"
        cd /Volumes/android
        git clone https://github.com/ReB2GOS/B2G -b master
        cd ./B2G
        REPO_INIT_FLAGS="--depth=1" REPO_SYNC_FLAGS="-j128" ./config.sh emulator-10
        df -h
#
#    - name: Setup Debug Session
#      uses: csexton/debugger-action@master

    - name: Initialization gecko environment and fix issue
      run: |
        df -h
        cd /Volumes/android
        cd ./B2G/gecko
        touch ./boot.exp
        echo "spawn ./mach bootstrap --no-system-changes" >> boot.exp  
        echo "expect  \"Your choice:\" " >> boot.exp
        echo "send \"4\r\" " >> boot.exp
        echo "expect  \"(Yn):\" " >> boot.exp
        echo "send \"Y\r\" " >> boot.exp
        echo "expect  \"(Yn):\" " >> boot.exp
        echo "send \"Y\r\" " >> boot.exp
        echo "interact " >> boot.exp
        cat ./boot.exp
        expect ./boot.exp
        cd ../
        sed -i '' '65i\'$'\n\"10\.15\"\,\n' build/soong/cc/config/x86_darwin_host.go
        cat ./build/soong/cc/config/x86_darwin_host.go 
        sed -i '' '14d'  system/sepolicy/Android.bp
        cat system/sepolicy/Android.bp
        df -h
        
    - name: Build B2G
      run: |
        df -h
        cd /Volumes/android/B2G
        export LOCAL_NDK_BASE_URL='ftp://ftp.kaiostech.com/ndk/android-ndk'
        ccache -M 50G
        export USE_CCACHE=1
        ./build.sh 
        df -h
        
    - name: Check
      run: |
        df -h
        ls -al /Volumes/android/B2G/out/target/product/
    - name: Remove android.img
      run: |
        cd ~
        hdiutil detach /Volumes/android
        
